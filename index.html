<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyCommitments Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#0f172a',
              secondary: '#334155',
              accent: '#2563eb',
              danger: '#ef4444',
              success: '#22c55e',
            }
          }
        }
      }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types (Required by Recharts) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Recharts (UMD Build) -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <!-- Lucide React (UMD Build) - Updated to 0.469.0 to include FileSpreadsheet -->
    <script src="https://unpkg.com/lucide-react@0.469.0/dist/umd/lucide-react.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .custom-scrollbar::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      /* Recharts font override */
      .recharts-wrapper { font-family: sans-serif; }
      
      /* Fade in animation */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .animate-in {
        animation: fadeIn 0.2s ease-out forwards;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useMemo } = React;
        
        // --- SAFELY LOAD UMD LIBRARIES ---
        
        // 1. Recharts
        const RechartsObj = window.Recharts || {};
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, Legend } = RechartsObj;

        // 2. Lucide React
        // Ensure we don't crash if an icon is missing. Use a Proxy or manual fallback.
        const LucideObj = window.lucideReact || window.LucideReact || {};
        
        // Fallback icon component
        const MissingIcon = (props) => <span style={{width: props.size || 16, height: props.size || 16, display: 'inline-block', backgroundColor: '#cbd5e1', borderRadius: 4}} title="Missing Icon"></span>;

        const getIcon = (name) => {
            return LucideObj[name] || MissingIcon;
        };

        // Destructure icons safely
        const Wallet = getIcon('Wallet');
        const TrendingUp = getIcon('TrendingUp');
        const AlertCircle = getIcon('AlertCircle');
        const PiggyBank = getIcon('PiggyBank');
        const Trash2 = getIcon('Trash2');
        const CheckSquare = getIcon('CheckSquare');
        const Square = getIcon('Square');
        const CheckCircle = getIcon('CheckCircle');
        const XCircle = getIcon('XCircle');
        const Ban = getIcon('Ban');
        const Clock = getIcon('Clock');
        const ExternalLink = getIcon('ExternalLink');
        const X = getIcon('X');
        const Save = getIcon('Save');
        const Plus = getIcon('Plus');
        const PieChartIcon = getIcon('PieChart'); // Renamed to avoid conflict if Recharts has PieChart
        const List = getIcon('List');
        const Download = getIcon('Download');
        const FileSpreadsheet = getIcon('FileSpreadsheet');
        const Calendar = getIcon('Calendar');
        const Circle = getIcon('Circle');

        // ----------------------------------------------------------------------
        // 1. TYPES & CONSTANTS
        // ----------------------------------------------------------------------

        interface FinancialRecord {
            id: string;
            year: number;
            month: string;
            
            // Income
            monthlySalary: number;
            extraIncome: number;
            
            // Commitments
            aeon: number;
            abah: number;
            refundMak: number;
            utilities: number;
            nafkahGroceries: number;
            refundAwien: number;
            refundNoah: number;
            tabungRaya: number;
            savingUnTouchable: number;
            savingTouchable: number;
            myRapid: number;
            gas: number;
            parking: number;
            topupMobile: number;
            food: number;
            shopee: number;
            others: number;
            noah: number;
            refundMadam: number;
            rental: number;
            djamelsFamily: number;

            // Meta
            refundInfo: string;
            remarks: string;
            isPaid: boolean;
            
            // Visuals
            cellColors?: Record<string, string>;
            rowColor?: string;
        }

        const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const YEARS = Array.from({ length: 13 }, (_, i) => 2024 + i); // 2024 to 2036

        const COMMITMENT_FIELDS = [
            { key: 'aeon', label: 'AEON', category: 'Debt' },
            { key: 'abah', label: 'ABAH', category: 'Family' },
            { key: 'refundMak', label: 'REFUND MAK', category: 'Family' },
            { key: 'utilities', label: 'UTILITIES', category: 'Living' },
            { key: 'nafkahGroceries', label: 'NAFKAH', category: 'Living' },
            { key: 'refundAwien', label: 'REFUND AWIEN', category: 'Family' },
            { key: 'refundNoah', label: 'REFUND NOAH', category: 'Family' },
            { key: 'tabungRaya', label: 'TABUNG RAYA', category: 'Savings' },
            { key: 'savingUnTouchable', label: 'SAVING (FIX)', category: 'Savings' },
            { key: 'savingTouchable', label: 'SAVING (FLEX)', category: 'Savings' },
            { key: 'myRapid', label: 'MYRAPID', category: 'Transport' },
            { key: 'gas', label: 'GAS', category: 'Living' },
            { key: 'parking', label: 'PARKING', category: 'Transport' },
            { key: 'topupMobile', label: 'TOPUP', category: 'Living' },
            { key: 'food', label: 'FOOD', category: 'Living' },
            { key: 'shopee', label: 'SHOPEE', category: 'Personal' },
            { key: 'others', label: 'OTHERS', category: 'Personal' },
            { key: 'noah', label: 'NOAH', category: 'Family' },
            { key: 'refundMadam', label: 'REFUND MADAM', category: 'Family' },
            { key: 'rental', label: 'RENTAL', category: 'Living' },
            { key: 'djamelsFamily', label: "DJAMEL'S FAM", category: 'Family' },
        ];

        const HISTORICAL_DATA: Record<string, Partial<FinancialRecord>> = {
            '2024-MAR': { monthlySalary: 2000, aeon: 250, abah: 400, refundAwien: 300, refundInfo: 'ATOME - FURNITURE', remarks: 'djamel paid by his march salary' },
            '2024-APR': { monthlySalary: 2000, aeon: 250, abah: 400, refundAwien: 300, savingUnTouchable: 25, refundInfo: 'SHOPBACK - AVILLION RM205...', remarks: '2nd pymt awie paid by her feb salary...' },
            '2024-MAY': { monthlySalary: 2000, aeon: 250, abah: 400, tabungRaya: 50, savingUnTouchable: 225, savingTouchable: 25, refundInfo: 'BAJU RAYA RM129 + FOOD + RM50', remarks: 'done refund' },
            '2024-JUN': { monthlySalary: 1500, extraIncome: 1000, aeon: 250, abah: 400, tabungRaya: 100, savingUnTouchable: 150, savingTouchable: 25, noah: 800, refundInfo: 'GROCERIES FOR RAYA...', remarks: 'awie paid on behalf djamel...' },
            '2024-JUL': { monthlySalary: 2000, extraIncome: 500, aeon: 250, abah: 400, tabungRaya: 100, savingUnTouchable: 410, refundInfo: '1. REPAIR DJAMEL BIKE...', remarks: '230.00...' },
            '2024-AUG': { monthlySalary: 1670, extraIncome: 1000, aeon: 250, abah: 400, tabungRaya: 100, myRapid: 50, parking: 50, remarks: 'MADAM OUTSTANDING PYMT...' },
            '2024-SEP': { monthlySalary: 2600, aeon: 250, abah: 400, tabungRaya: 100, savingUnTouchable: 70, savingTouchable: 25, myRapid: 50, shopee: 242, others: 200, refundInfo: 'REFUND AWIEN RM70...', remarks: 'Shopee item: (oct bill)...' },
            '2024-OCT': { monthlySalary: 2304, aeon: 250, abah: 400, refundAwien: 300, refundNoah: 590, savingTouchable: 25, myRapid: 70, food: 285, shopee: 200, refundInfo: 'RM200 TO PAY IMRAN...', remarks: 'Shopee item:(oct & nov bill)...' },
            '2024-NOV': { monthlySalary: 2476, aeon: 250, abah: 400, refundAwien: 300, refundNoah: 242, savingTouchable: 25, gas: 550, parking: 50, topupMobile: 20, food: 25, shopee: 30, others: 315, noah: 200, refundInfo: 'RM42 PASTA...', remarks: 'Shopee item:(dec bill)...' },
            '2024-DEC': { monthlySalary: 2600, aeon: 250, abah: 600, refundAwien: 300, refundNoah: 150, savingTouchable: 25, gas: 550, parking: 50, topupMobile: 20, food: 30, shopee: 289, others: 225, refundInfo: 'RM100 MEALS...', remarks: 'Shopee item: (jan bill)...' },
            
            // 2025 CORRECTED DATA
            '2025-JAN': { monthlySalary: 1560, aeon: 250, abah: 600, nafkahGroceries: 200, tabungRaya: 25, myRapid: 50, gas: 20, topupMobile: 30, shopee: 262, cellColors: { tabungRaya: '#ef4444' }, remarks: 'Shopee item: (feb bill)...' },
            '2025-FEB': { monthlySalary: 2080, aeon: 250, abah: 600, nafkahGroceries: 300, refundAwien: 200, refundNoah: 50, savingTouchable: 50, gas: 20, topupMobile: 30, shopee: 262, refundMadam: 100, rental: 100, remarks: 'Shopee item: (mac bill)...' },
            '2025-MAR': { monthlySalary: 2600, aeon: 250, abah: 600, nafkahGroceries: 300, tabungRaya: 25, savingUnTouchable: 550, savingTouchable: 60, myRapid: 20, gas: 25, topupMobile: 30, shopee: 156, others: 150, refundMadam: 100, rental: 100, remarks: 'Shopee item: (apr bill)...' },
            '2025-APR': { monthlySalary: 2600, aeon: 250, abah: 600, nafkahGroceries: 300, refundAwien: 405, tabungRaya: 25, savingUnTouchable: 200, savingTouchable: 50, myRapid: 20, gas: 25, topupMobile: 30, shopee: 172, others: 142, refundMadam: 100, rental: 100, refundInfo: 'REFUND AWIEN RM200...', remarks: 'Shopee item: (may bill)...' },
            '2025-MAY': { monthlySalary: 3500, aeon: 250, abah: 600, refundMak: 75, utilities: 500, nafkahGroceries: 300, refundAwien: 500, refundNoah: 25, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, shopee: 160, others: 422, refundMadam: 100, rental: 100, refundInfo: 'REFUND NOAH RM200...', remarks: 'Shopee item: (jun bill)...' },
            '2025-JUN': { monthlySalary: 3500, aeon: 250, abah: 600, refundMak: 75, utilities: 500, nafkahGroceries: 455, refundNoah: 25, savingUnTouchable: 500, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, food: 230, shopee: 326, others: 142, refundMadam: 100, rental: 100, refundInfo: 'REFUND TRADE RM300...', remarks: 'Shopee item: (july bill)...' },
            '2025-JUL': { monthlySalary: 3500, aeon: 250, abah: 700, refundMak: 200, utilities: 75, nafkahGroceries: 500, refundAwien: 150, refundNoah: 25, savingUnTouchable: 500, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, food: 230, shopee: 343, others: 142, refundMadam: 100, rental: 100, remarks: 'Shopee item: (aug bill)...' },
            '2025-AUG': { monthlySalary: 3500, aeon: 250, abah: 700, refundMak: 200, utilities: 75, nafkahGroceries: 500, refundNoah: 25, savingUnTouchable: 700, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, food: 230, shopee: 397, refundMadam: 100, djamelsFamily: 57, remarks: 'Shopee item: (sept bill)...' },
            '2025-SEP': { monthlySalary: 3500, aeon: 250, abah: 700, refundMak: 200, utilities: 75, nafkahGroceries: 500, refundNoah: 25, savingUnTouchable: 800, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, food: 230, shopee: 202, refundMadam: 100, rental: 100, remarks: 'Shopee item:...' },
            '2025-OCT': { monthlySalary: 3500, aeon: 250, abah: 700, utilities: 75, nafkahGroceries: 500, refundAwien: 153, refundNoah: 25, savingUnTouchable: 500, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, food: 230, shopee: 161, refundMadam: 100, rental: 100, refundInfo: 'HOTEL RM153', remarks: 'Shopee item:...' },
            '2025-NOV': { monthlySalary: 3500, aeon: 250, abah: 100, refundMak: 200, utilities: 100, nafkahGroceries: 500, refundAwien: 153, refundNoah: 25, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, food: 189, shopee: 120, others: 100, noah: 300, refundMadam: 1150, refundInfo: 'HOTEL RM153', remarks: 'Shopee item:...' },
            '2025-DEC': { monthlySalary: 3500, aeon: 250, abah: 100, refundMak: 150, utilities: 100, nafkahGroceries: 500, refundAwien: 153, refundNoah: 25, savingTouchable: 50, gas: 20, parking: 25, topupMobile: 30, food: 158, others: 100, noah: 300, refundMadam: 1150, refundInfo: 'HOTEL RM153', remarks: 'Shopee item:...' },
        };

        const generateInitialRecords = () => {
            const records = [];
            let idCounter = 1;

            YEARS.forEach(year => {
                MONTHS.forEach(month => {
                    if (year === 2024 && (month === 'JAN' || month === 'FEB')) return;

                    const key = `${year}-${month}`;
                    let record = {
                        id: `gen-${year}-${month}-${idCounter++}`,
                        year,
                        month,
                        monthlySalary: 3500,
                        extraIncome: 0,
                        aeon: 0,
                        abah: 0,
                        refundMak: 0,
                        utilities: 0,
                        nafkahGroceries: 0,
                        refundAwien: 0,
                        refundNoah: 0,
                        tabungRaya: 0,
                        savingUnTouchable: 0,
                        savingTouchable: 0,
                        myRapid: 0,
                        gas: 0,
                        parking: 0,
                        topupMobile: 0,
                        food: 0,
                        shopee: 0,
                        others: 0,
                        noah: 0,
                        refundMadam: 0,
                        rental: 0,
                        djamelsFamily: 0,
                        refundInfo: '',
                        remarks: '',
                        isPaid: false,
                        cellColors: {}
                    };

                    if (HISTORICAL_DATA[key]) {
                        record = { ...record, ...HISTORICAL_DATA[key] };
                    } else if (year >= 2026) {
                        record.monthlySalary = 3500;
                        record.aeon = 250;
                        record.abah = 100;
                        record.utilities = 100;
                        record.nafkahGroceries = 500;
                        record.refundNoah = 25;
                        record.gas = 300;
                        record.parking = 50;
                        record.topupMobile = 20;
                        record.food = 25;
                        record.shopee = 30;
                        record.noah = 150;
                        record.rental = 1150;
                        record.djamelsFamily = 100;

                        if (year === 2026 && ['JAN','FEB','MAR','APR'].includes(month)) {
                            record.remarks = "EXTEND STUDY FEES RM1200 (RM300X4) 16/6/2024 - AWIEN";
                        }
                    }

                    records.push(record);
                });
            });
            
            return records;
        };

        const INITIAL_RECORDS = generateInitialRecords();

        // ----------------------------------------------------------------------
        // 2. CALCULATIONS
        // ----------------------------------------------------------------------

        const calculateTotalIncome = (record) => {
            return (Number(record.monthlySalary) || 0) + (Number(record.extraIncome) || 0);
        };

        const calculateTotalCommitments = (record) => {
            return COMMITMENT_FIELDS.reduce((total, field) => {
                return total + (Number(record[field.key]) || 0);
            }, 0);
        };

        const calculateBalance = (record) => {
            return calculateTotalIncome(record) - calculateTotalCommitments(record);
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-MY', {
                style: 'currency',
                currency: 'MYR',
                minimumFractionDigits: 2
            }).format(amount);
        };

        const getAggregatedStats = (records) => {
            let totalIncome = 0;
            let totalCommitments = 0;
            let totalBalance = 0;
            let totalSavings = 0;

            records.forEach(record => {
                const inc = calculateTotalIncome(record);
                const comm = calculateTotalCommitments(record);
                const bal = inc - comm;

                totalIncome += inc;
                totalCommitments += comm;
                totalBalance += bal;
                
                totalSavings += (Number(record.tabungRaya) || 0) + (Number(record.savingUnTouchable) || 0) + (Number(record.savingTouchable) || 0);
            });

            return { totalIncome, totalCommitments, totalBalance, totalSavings };
        };

        // ----------------------------------------------------------------------
        // 3. COMPONENTS
        // ----------------------------------------------------------------------

        // --- SummaryCards ---
        const SummaryCards = ({
            totalIncome,
            totalCommitments,
            totalBalance,
            totalSavings
        }) => {
            return (
                <div className="flex gap-4 min-w-max px-2">
                    <div className="flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2">
                        <div className="p-1.5 rounded-full bg-green-100 text-green-600">
                            <Wallet size={16} />
                        </div>
                        <div>
                            <p className="text-[10px] text-slate-500 font-medium uppercase">Balance</p>
                            <h3 className="text-sm font-bold text-slate-800">{formatCurrency(totalBalance)}</h3>
                        </div>
                    </div>

                    <div className="flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2">
                        <div className="p-1.5 rounded-full bg-red-100 text-red-600">
                            <TrendingUp size={16} />
                        </div>
                        <div>
                            <p className="text-[10px] text-slate-500 font-medium uppercase">Commitments</p>
                            <h3 className="text-sm font-bold text-slate-800">{formatCurrency(totalCommitments)}</h3>
                        </div>
                    </div>

                    <div className="flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2">
                        <div className="p-1.5 rounded-full bg-blue-100 text-blue-600">
                            <PiggyBank size={16} />
                        </div>
                        <div>
                            <p className="text-[10px] text-slate-500 font-medium uppercase">Savings</p>
                            <h3 className="text-sm font-bold text-slate-800">{formatCurrency(totalSavings)}</h3>
                        </div>
                    </div>

                    <div className="flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2">
                        <div className="p-1.5 rounded-full bg-amber-100 text-amber-600">
                            <AlertCircle size={16} />
                        </div>
                        <div>
                            <p className="text-[10px] text-slate-500 font-medium uppercase">Ratio</p>
                            <h3 className="text-sm font-bold text-slate-800">
                                {totalIncome > 0 ? Math.round((totalCommitments / totalIncome) * 100) : 0}%
                            </h3>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MonthDetailModal ---
        const MonthDetailModal = ({
            isOpen,
            onClose,
            record,
            onUpdateRecord,
        }) => {
            if (!isOpen || !record) return null;

            const totalCommitments = calculateTotalCommitments(record);

            const handleAmountChange = (fieldKey, value) => {
                const numValue = parseFloat(value) || 0;
                onUpdateRecord({
                    ...record,
                    [fieldKey]: numValue,
                });
            };

            const handleStatusChange = (fieldKey, color) => {
                onUpdateRecord({
                    ...record,
                    cellColors: {
                        ...record.cellColors,
                        [fieldKey]: color,
                    },
                });
            };

            const getCardColor = (key) => {
                const color = record.cellColors?.[key];
                if (color === '#86efac') return 'bg-green-50 border-green-200'; // Paid
                if (color === '#fca5a5') return 'bg-red-50 border-red-200';     // Cancelled
                if (color === '#fcd34d') return 'bg-yellow-50 border-yellow-200'; // Pending
                return 'bg-white border-slate-200';
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden">
                        <div className="bg-white p-4 border-b border-slate-200 flex justify-between items-center shadow-sm z-10">
                            <div>
                                <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2">
                                    <span className="text-blue-600">{record.month}</span>
                                    <span className="text-slate-400">{record.year}</span>
                                </h2>
                                <p className="text-slate-500 text-sm font-medium mt-1">
                                    Total Commitments: <span className="text-slate-800 font-bold">{formatCurrency(totalCommitments)}</span>
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-500 transition-colors">
                                <X size={24} />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar">
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                {COMMITMENT_FIELDS.map((field) => {
                                    const value = record[field.key];
                                    const currentColor = record.cellColors?.[field.key];

                                    return (
                                        <div key={field.key} className={`relative flex flex-col p-4 rounded-xl border-2 shadow-sm transition-all duration-200 hover:shadow-md ${getCardColor(field.key)}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="text-xs font-bold text-slate-500 uppercase tracking-tight truncate w-full" title={field.label}>
                                                    {field.label}
                                                </span>
                                            </div>

                                            <div className="relative mb-4 group">
                                                <span className="absolute left-0 top-1/2 -translate-y-1/2 text-slate-400 font-medium text-sm">RM</span>
                                                <input
                                                    type="number"
                                                    value={value || ''}
                                                    onChange={(e) => handleAmountChange(field.key, e.target.value)}
                                                    className="w-full bg-transparent text-2xl font-bold text-slate-800 outline-none pl-7 border-b border-transparent hover:border-slate-300 focus:border-blue-500 transition-colors text-right"
                                                    placeholder="0"
                                                />
                                            </div>

                                            <div className="mt-auto grid grid-cols-4 gap-1 pt-3 border-t border-black/5">
                                                <button onClick={() => handleStatusChange(field.key, '#86efac')} className={`flex justify-center items-center p-1.5 rounded-lg transition-colors ${currentColor === '#86efac' ? 'bg-green-500 text-white shadow-inner' : 'hover:bg-green-100 text-green-600'}`} title="Mark Paid">
                                                    <CheckCircle size={18} />
                                                </button>
                                                <button onClick={() => handleStatusChange(field.key, '#fcd34d')} className={`flex justify-center items-center p-1.5 rounded-lg transition-colors ${currentColor === '#fcd34d' ? 'bg-yellow-500 text-white shadow-inner' : 'hover:bg-yellow-100 text-yellow-600'}`} title="Mark Pending">
                                                    <AlertCircle size={18} />
                                                </button>
                                                <button onClick={() => handleStatusChange(field.key, '#fca5a5')} className={`flex justify-center items-center p-1.5 rounded-lg transition-colors ${currentColor === '#fca5a5' ? 'bg-red-500 text-white shadow-inner' : 'hover:bg-red-100 text-red-600'}`} title="Mark Cancelled">
                                                    <Ban size={18} />
                                                </button>
                                                <button onClick={() => handleStatusChange(field.key, '')} className="flex justify-center items-center p-1.5 rounded-lg hover:bg-slate-200 text-slate-400" title="Clear Status">
                                                    <Circle size={18} />
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="bg-slate-100 p-2 text-center text-xs text-slate-400 border-t border-slate-200">
                            Click the color icons to update status instantly. Edit amount by typing directly.
                        </div>
                    </div>
                </div>
            );
        };

        // --- EditModal ---
        const EMPTY_RECORD = {
            id: '',
            year: new Date().getFullYear(),
            month: MONTHS[0],
            monthlySalary: 3500,
            extraIncome: 0,
            aeon: 250,
            abah: 100,
            refundMak: 100,
            utilities: 100,
            nafkahGroceries: 200,
            refundAwien: 0,
            refundNoah: 0,
            tabungRaya: 20,
            savingUnTouchable: 25,
            savingTouchable: 30,
            myRapid: 0,
            gas: 0,
            parking: 0,
            topupMobile: 30,
            food: 150,
            shopee: 0,
            others: 0,
            noah: 0,
            refundMadam: 0,
            rental: 1150,
            djamelsFamily: 100,
            refundInfo: '',
            remarks: '',
            isPaid: false
        };

        const EditModal = ({ isOpen, onClose, onSave, initialData }) => {
            const [formData, setFormData] = useState(EMPTY_RECORD);

            useEffect(() => {
                if (initialData) {
                    setFormData(initialData);
                } else {
                    setFormData({ ...EMPTY_RECORD, id: Date.now().toString() });
                }
            }, [initialData, isOpen]);

            if (!isOpen) return null;

            const handleChange = (e) => {
                const { name, value, type } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'number' ? parseFloat(value) || 0 : value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-in fade-in zoom-in duration-200">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-slate-800">
                                {initialData ? 'Edit Record' : 'New Monthly Record'}
                            </h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-50 rounded-full transition-colors">
                                <X size={24} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                            <div className="mb-8">
                                <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Period</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Year</label>
                                        <select name="year" value={formData.year} onChange={handleChange} className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Month</label>
                                        <select name="month" value={formData.month} onChange={handleChange} className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                            {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div className="mb-8">
                                <h3 className="text-sm font-semibold text-green-600 uppercase tracking-wider mb-4 flex items-center">Income (+)</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Monthly Salary</label>
                                        <input type="number" step="0.01" name="monthlySalary" value={formData.monthlySalary} onChange={handleChange} className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Extra Income</label>
                                        <input type="number" step="0.01" name="extraIncome" value={formData.extraIncome} onChange={handleChange} className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" />
                                    </div>
                                </div>
                            </div>

                            <div className="mb-8">
                                <h3 className="text-sm font-semibold text-red-600 uppercase tracking-wider mb-4">Commitments (-)</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                    {COMMITMENT_FIELDS.map(field => (
                                        <div key={field.key}>
                                            <label className="block text-xs font-medium text-slate-500 mb-1 truncate" title={field.label}>{field.label}</label>
                                            <input type="number" step="0.01" name={field.key} value={formData[field.key]} onChange={handleChange} className="w-full rounded-lg border-slate-300 border p-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none text-sm" />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-4">
                                <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Details</h3>
                                <div className="grid grid-cols-1 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Refund Info</label>
                                        <input type="text" name="refundInfo" value={formData.refundInfo} onChange={handleChange} className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="e.g. Hotel RM153" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Remarks</label>
                                        <textarea name="remarks" value={formData.remarks} onChange={handleChange} className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" rows={3} placeholder="General remarks or payment details..." />
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div className="p-6 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-2xl">
                            <button type="button" onClick={onClose} className="px-5 py-2.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Cancel</button>
                            <button type="button" onClick={handleSubmit} className="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center gap-2">
                                <Save size={18} />
                                Save Record
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- FinancialTable ---
        const COLORS = [
            { name: 'Blue', value: '#93c5fd' },
            { name: 'Purple', value: '#d8b4fe' },
            { name: 'Gray', value: '#cbd5e1' },
        ];

        const FinancialTable = ({ records, onUpdateRecord, onDelete, onMonthClick }) => {
            const [contextMenu, setContextMenu] = useState(null);

            const sortedRecords = [...records].sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return MONTHS.indexOf(a.month) - MONTHS.indexOf(b.month);
            });

            useEffect(() => {
                const handleClick = () => setContextMenu(null);
                window.addEventListener('click', handleClick);
                return () => window.removeEventListener('click', handleClick);
            }, []);

            const handleContextMenu = (e, recordId, fieldKey) => {
                e.preventDefault();
                setContextMenu({ x: e.clientX, y: e.clientY, recordId, fieldKey });
            };

            const handleColorSelect = (color) => {
                if (!contextMenu) return;
                const record = records.find(r => r.id === contextMenu.recordId);
                if (record) {
                    onUpdateRecord({
                        ...record,
                        cellColors: { ...record.cellColors, [contextMenu.fieldKey]: color }
                    });
                }
                setContextMenu(null);
            };

            const handleCellChange = (id, field, value) => {
                const record = records.find(r => r.id === id);
                if (record) {
                    const numValue = (typeof record[field] === 'number') ? (parseFloat(value) || 0) : value;
                    onUpdateRecord({ ...record, [field]: numValue });
                }
            };

            const togglePaidStatus = (id) => {
                const record = records.find(r => r.id === id);
                if (record) onUpdateRecord({ ...record, isPaid: !record.isPaid });
            };

            return (
                <div className="flex flex-col h-full bg-white shadow-sm border border-slate-300 overflow-hidden text-xs select-none">
                    <div className="flex-1 overflow-auto custom-scrollbar relative">
                        <table className="min-w-max border-collapse border-spacing-0 table-fixed">
                            <colgroup>
                                <col className="w-12" />
                                <col className="w-12" />
                                <col className="w-[70px]" />
                                <col className="w-[70px]" />
                                <col className="w-[80px]" />
                                {COMMITMENT_FIELDS.map(field => <col key={field.key} className="w-[90px]" />)}
                                <col className="w-[80px]" />
                                <col className="w-[80px]" />
                                <col className="w-[150px]" />
                                <col className="w-[200px]" />
                                <col className="w-10" />
                                <col className="w-10" />
                            </colgroup>

                            <thead className="sticky top-0 z-40 bg-slate-100 text-slate-700 font-semibold shadow-sm h-10">
                                <tr>
                                    <th className="border border-slate-300 p-1 sticky left-0 bg-slate-100 z-50 text-center shadow-[1px_0_0_0_#cbd5e1]">YEAR</th>
                                    <th className="border border-slate-300 p-1 sticky left-12 bg-slate-100 z-50 text-center shadow-[1px_0_0_0_#cbd5e1]">MONTH</th>
                                    <th className="border border-slate-300 p-1 bg-green-50 text-center text-green-800">SALARY</th>
                                    <th className="border border-slate-300 p-1 bg-green-50 text-center text-green-800">EXTRA</th>
                                    <th className="border border-slate-300 p-1 bg-green-100 font-bold text-center text-green-900">TOTAL</th>
                                    {COMMITMENT_FIELDS.map(field => (
                                        <th key={field.key} className="border border-slate-300 p-1 bg-red-50 truncate px-1 text-center text-red-800" title={field.label}>{field.label}</th>
                                    ))}
                                    <th className="border border-slate-300 p-1 bg-red-100 font-bold text-center text-red-900">TOTAL</th>
                                    <th className="border border-slate-300 p-1 bg-blue-100 font-bold text-center text-blue-900">BALANCE</th>
                                    <th className="border border-slate-300 p-1 text-center text-slate-600">REFUND INFO</th>
                                    <th className="border border-slate-300 p-1 text-center text-slate-600">REMARKS</th>
                                    <th className="border border-slate-300 p-1 text-center text-slate-600">PAID</th>
                                    <th className="border border-slate-300 p-1 text-center text-slate-600">DEL</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white">
                                {sortedRecords.map((record, index) => {
                                    const prevRecord = sortedRecords[index - 1];
                                    const isNewYear = !prevRecord || prevRecord.year !== record.year;
                                    const totalIncome = calculateTotalIncome(record);
                                    const totalCommitment = calculateTotalCommitments(record);
                                    const balance = calculateBalance(record);

                                    return (
                                        <tr key={record.id} className={`hover:bg-slate-50/50 ${record.isPaid ? 'bg-green-50/30' : ''}`}>
                                            <td className="border border-slate-300 p-0 text-center font-bold text-slate-600 align-top pt-2 sticky left-0 bg-white z-30 shadow-[1px_0_0_0_#cbd5e1]">
                                                {isNewYear ? record.year : <span className="text-slate-200 select-none text-[10px]">{record.year}</span>}
                                            </td>
                                            <td className={`border border-slate-300 p-0 sticky left-12 z-30 shadow-[1px_0_0_0_#cbd5e1] ${record.cellColors?.['month'] ? '' : 'bg-white'}`} style={{ backgroundColor: record.cellColors?.['month'] }}>
                                                <button onClick={() => onMonthClick(record)} className="w-full h-full px-1 py-1 font-medium text-center hover:bg-blue-50 text-blue-600 hover:text-blue-800 transition-colors flex items-center justify-center gap-1 group" title="Open Month Dashboard">
                                                    {record.month}
                                                </button>
                                            </td>
                                            <td className="border border-slate-300 p-0" style={{ backgroundColor: record.cellColors?.['monthlySalary'] }} onContextMenu={(e) => handleContextMenu(e, record.id, 'monthlySalary')}>
                                                <input type="number" className={`w-full h-full px-1 py-1 text-right bg-transparent outline-none focus:bg-blue-50 ${record.isPaid ? 'text-green-700' : ''}`} value={record.monthlySalary || ''} onChange={(e) => handleCellChange(record.id, 'monthlySalary', e.target.value)} />
                                            </td>
                                            <td className="border border-slate-300 p-0" style={{ backgroundColor: record.cellColors?.['extraIncome'] }} onContextMenu={(e) => handleContextMenu(e, record.id, 'extraIncome')}>
                                                <input type="number" className={`w-full h-full px-1 py-1 text-right bg-transparent outline-none focus:bg-blue-50 ${record.isPaid ? 'text-green-700' : ''}`} value={record.extraIncome || ''} onChange={(e) => handleCellChange(record.id, 'extraIncome', e.target.value)} />
                                            </td>
                                            <td className="border border-slate-300 p-1 text-right font-bold text-green-700 bg-green-50 select-text">{totalIncome.toFixed(0)}</td>
                                            {COMMITMENT_FIELDS.map(field => (
                                                <td key={field.key} className="border border-slate-300 p-0" style={{ backgroundColor: record.cellColors?.[field.key] }} onContextMenu={(e) => handleContextMenu(e, record.id, field.key)}>
                                                    <input type="number" className={`w-full h-full px-1 py-1 text-right bg-transparent outline-none focus:bg-blue-50 text-slate-600 font-medium ${record.isPaid ? 'text-slate-400' : ''}`} value={record[field.key] || ''} onChange={(e) => handleCellChange(record.id, field.key, e.target.value)} />
                                                </td>
                                            ))}
                                            <td className="border border-slate-300 p-1 text-right font-bold text-red-700 bg-red-50 select-text">{totalCommitment.toFixed(0)}</td>
                                            <td className={`border border-slate-300 p-1 text-right font-bold select-text ${balance < 0 ? 'text-red-600' : 'text-blue-600'} bg-blue-50`}>{balance.toFixed(0)}</td>
                                            <td className="border border-slate-300 p-0" style={{ backgroundColor: record.cellColors?.['refundInfo'] }} onContextMenu={(e) => handleContextMenu(e, record.id, 'refundInfo')}>
                                                <input type="text" className="w-full h-full px-1 py-1 bg-transparent outline-none focus:bg-blue-50 text-[10px]" value={record.refundInfo} onChange={(e) => handleCellChange(record.id, 'refundInfo', e.target.value)} />
                                            </td>
                                            <td className="border border-slate-300 p-0" style={{ backgroundColor: record.cellColors?.['remarks'] }} onContextMenu={(e) => handleContextMenu(e, record.id, 'remarks')}>
                                                <input type="text" className="w-full h-full px-1 py-1 bg-transparent outline-none focus:bg-blue-50 text-[10px]" value={record.remarks} onChange={(e) => handleCellChange(record.id, 'remarks', e.target.value)} />
                                            </td>
                                            <td className="border border-slate-300 p-0 text-center align-middle cursor-pointer" onClick={() => togglePaidStatus(record.id)}>
                                                <div className="flex justify-center items-center h-full">
                                                    {record.isPaid ? <CheckSquare size={14} className="text-green-600" /> : <Square size={14} className="text-slate-300 hover:text-slate-500" />}
                                                </div>
                                            </td>
                                            <td className="border border-slate-300 p-0 text-center align-middle">
                                                <button onClick={() => onDelete(record.id)} className="text-slate-300 hover:text-red-500 p-1 flex justify-center items-center w-full h-full"><Trash2 size={12} /></button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    
                    <div className="p-2 bg-slate-50 border-t border-slate-300 text-xs text-slate-500 flex justify-between items-center">
                        <span>Right-click cell to set Status, or click <span className="text-blue-600 font-bold">Month Name</span> for Dashboard.</span>
                        <span>Records: {records.length}</span>
                    </div>

                    {contextMenu && (
                        <div className="fixed z-50 bg-white border border-slate-200 shadow-xl rounded-lg p-1 w-48 animate-in fade-in zoom-in duration-75" style={{ top: contextMenu.y, left: contextMenu.x }} onClick={(e) => e.stopPropagation()}>
                            <div className="text-[10px] font-semibold text-slate-400 px-2 py-1 uppercase border-b border-slate-50">Set Status</div>
                            <button onClick={() => handleColorSelect('#86efac')} className="flex items-center gap-2 px-2 py-2 text-xs hover:bg-green-50 rounded text-left w-full text-green-800 font-medium"><CheckCircle size={14} className="text-green-600" /><span>Paid (Green)</span></button>
                            <button onClick={() => handleColorSelect('#fca5a5')} className="flex items-center gap-2 px-2 py-2 text-xs hover:bg-red-50 rounded text-left w-full text-red-800 font-medium"><Ban size={14} className="text-red-600" /><span>Cancelled (Red)</span></button>
                            <button onClick={() => handleColorSelect('#fcd34d')} className="flex items-center gap-2 px-2 py-2 text-xs hover:bg-yellow-50 rounded text-left w-full text-yellow-800 font-medium"><Clock size={14} className="text-yellow-600" /><span>Pending (Yellow)</span></button>
                            <button onClick={() => handleColorSelect('')} className="flex items-center gap-2 px-2 py-2 text-xs hover:bg-slate-50 rounded text-left w-full text-slate-600 border-t border-slate-100 mt-1"><XCircle size={14} /><span>Clear Status</span></button>
                            <div className="text-[10px] font-semibold text-slate-400 px-2 py-1 uppercase mt-1 border-t border-slate-50">Custom</div>
                            <div className="grid grid-cols-3 gap-1 p-1">
                                {COLORS.map(color => (
                                    <button key={color.name} onClick={() => handleColorSelect(color.value)} title={color.name} className="w-full h-6 rounded border border-slate-200 shadow-sm hover:scale-105 transition-transform" style={{ backgroundColor: color.value || 'white' }}></button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Analytics ---
        const Analytics = ({ records }) => {
            // Safe guard if Recharts is not loaded
            if (!AreaChart || !BarChart) {
               return <div className="text-center p-10 text-slate-400">Analytics module is unavailable (Charts library not loaded).</div>;
            }

            const chartData = [...records]
                .sort((a, b) => {
                    if (a.year !== b.year) return a.year - b.year;
                    return MONTHS.indexOf(a.month) - MONTHS.indexOf(b.month);
                })
                .map(record => ({
                    name: `${record.month} ${record.year}`,
                    Income: calculateTotalIncome(record),
                    Expenses: calculateTotalCommitments(record),
                    Balance: calculateBalance(record),
                    Savings: (record.tabungRaya || 0) + (record.savingUnTouchable || 0) + (record.savingTouchable || 0)
                }));

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-4">Income vs Expenses Trend</h3>
                        <div className="h-[300px]">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={chartData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                    <defs>
                                        <linearGradient id="colorIncome" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#22c55e" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#22c55e" stopOpacity={0}/>
                                        </linearGradient>
                                        <linearGradient id="colorExpenses" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#ef4444" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#ef4444" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                    <XAxis dataKey="name" fontSize={12} tickLine={false} axisLine={false} />
                                    <YAxis fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `RM${value/1000}k`} />
                                    <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} formatter={(value) => [`RM ${value.toFixed(2)}`, '']} />
                                    <Legend />
                                    <Area type="monotone" dataKey="Income" stroke="#22c55e" fillOpacity={1} fill="url(#colorIncome)" strokeWidth={2} />
                                    <Area type="monotone" dataKey="Expenses" stroke="#ef4444" fillOpacity={1} fill="url(#colorExpenses)" strokeWidth={2} />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 mb-4">Monthly Balance & Savings</h3>
                        <div className="h-[300px]">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={chartData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                    <XAxis dataKey="name" fontSize={12} tickLine={false} axisLine={false} />
                                    <YAxis fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `RM${value}`} />
                                    <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                    <Legend />
                                    <Bar dataKey="Balance" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                                    <Bar dataKey="Savings" fill="#f59e0b" radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        // --- App ---
        const App = () => {
            const [records, setRecords] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [viewMode, setViewMode] = useState('table');
            const [selectedMonthRecord, setSelectedMonthRecord] = useState(null);

            useEffect(() => {
                const savedData = localStorage.getItem('financial_records_v5');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed && parsed.length > 0) {
                            setRecords(parsed);
                        } else {
                            setRecords(INITIAL_RECORDS);
                        }
                    } catch (e) {
                        setRecords(INITIAL_RECORDS);
                    }
                } else {
                    setRecords(INITIAL_RECORDS);
                }
            }, []);

            useEffect(() => {
                if (records.length > 0) {
                    localStorage.setItem('financial_records_v5', JSON.stringify(records));
                }
            }, [records]);

            const monthOptions = useMemo(() => {
                return records.map(r => ({ id: r.id, label: `${r.month} ${r.year}`, value: r.id }));
            }, [records]);

            const handleAddRecord = () => {
                setEditingRecord(null);
                setIsModalOpen(true);
            };

            const handleSaveRecord = (record) => {
                if (editingRecord) {
                    setRecords(prev => prev.map(r => r.id === record.id ? record : r));
                } else {
                    setRecords(prev => [...prev, { ...record, id: Date.now().toString() }]);
                }
            };

            const handleUpdateRecord = (updatedRecord) => {
                setRecords(prev => prev.map(r => r.id === updatedRecord.id ? updatedRecord : r));
                if (selectedMonthRecord && selectedMonthRecord.id === updatedRecord.id) {
                    setSelectedMonthRecord(updatedRecord);
                }
            };

            const handleDeleteRecord = (id) => {
                if (window.confirm('Are you sure you want to delete this record?')) {
                    setRecords(prev => prev.filter(r => r.id !== id));
                }
            };

            const handleExportData = () => {
                const dataStr = JSON.stringify(records, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `financial_records_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleJumpToMonth = (recordId) => {
                if (!recordId) return;
                const record = records.find(r => r.id === recordId);
                if (record) setSelectedMonthRecord(record);
            };

            const stats = getAggregatedStats(records);

            return (
                <div className="h-screen bg-slate-50 flex flex-col overflow-hidden">
                    <header className="bg-white border-b border-slate-200 flex-none">
                        <div className="w-full px-4 h-14 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-green-600 p-1.5 rounded-lg"><FileSpreadsheet className="text-white" size={20} /></div>
                                <h1 className="text-lg font-bold text-slate-800 tracking-tight hidden sm:block">MyCommitments</h1>
                            </div>
                            <div className="hidden md:flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">
                                <Calendar size={14} className="text-slate-500" />
                                <span className="text-xs font-medium text-slate-500 whitespace-nowrap">Jump to:</span>
                                <select className="bg-transparent text-sm font-bold text-slate-700 outline-none cursor-pointer" onChange={(e) => handleJumpToMonth(e.target.value)} value="">
                                    <option value="" disabled>Select Month...</option>
                                    {monthOptions.map(opt => <option key={opt.id} value={opt.value}>{opt.label}</option>)}
                                </select>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button onClick={() => setViewMode('table')} className={`px-3 py-1 rounded-md text-sm font-medium transition-all ${viewMode === 'table' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><span className="flex items-center gap-2"><List size={14} /> Data</span></button>
                                    <button onClick={() => setViewMode('analytics')} className={`px-3 py-1 rounded-md text-sm font-medium transition-all ${viewMode === 'analytics' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><span className="flex items-center gap-2"><PieChartIcon size={14} /> Analytics</span></button>
                                </div>
                                <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                <button onClick={handleExportData} className="p-1.5 text-slate-500 hover:bg-slate-100 rounded-md transition-colors" title="Export JSON"><Download size={18} /></button>
                                <button onClick={handleAddRecord} className="bg-blue-600 hover:bg-blue-700 text-white p-1.5 rounded-md transition-colors shadow-sm" title="Add Record"><Plus size={18} /></button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 w-full overflow-hidden flex flex-col relative">
                        <div className="flex-none bg-white border-b border-slate-200 p-2 overflow-x-auto">
                            <SummaryCards {...stats} />
                        </div>
                        <div className="flex-1 overflow-hidden p-0 bg-white">
                            {viewMode === 'table' ? (
                                <FinancialTable records={records} onUpdateRecord={handleUpdateRecord} onDelete={handleDeleteRecord} onMonthClick={setSelectedMonthRecord} />
                            ) : (
                                <div className="p-4 overflow-auto h-full"><Analytics records={records} /></div>
                            )}
                        </div>
                    </main>
                    <EditModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveRecord} initialData={editingRecord} />
                    <MonthDetailModal isOpen={!!selectedMonthRecord} onClose={() => setSelectedMonthRecord(null)} record={selectedMonthRecord} onUpdateRecord={handleUpdateRecord} />
                </div>
            );
        };

        // --- Mount ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>